${SHARP} Bottle controller for entity ${entity.name}
${SHARP} Created on $today.date ( Time $today.time )
##
#set( $foreign_table = '' )
#set( $foreign_table_cap = '' )
#set( $cpt = 0 )
#set( $check_fk = false )
#set( $list = "" )
## #set( $select = "" )
#set( $uncapEntityName = ${fn.uncapitalize(${entity.name})} )
##
from bottle import view, request, route, template
import datetime

from controllers.commons.util import FORM_CREATE_MODE, FORM_UPDATE_MODE, create_msg, delete_msg, update_msg, error_msg
## from services import ${entity.name}_service as commons_entity_service
${SHARP} '$entity.name' entity class 
from entities.${entity.name}_class import $entity.name 

${SHARP} main service for '$entity.name' entity  
from services.${entity.name}_service import ${entity.name}Service
${fn.toLowerCase($entity.name)}_service = ${entity.name}Service()

${SHARP} other services for referenced entities 
#if( $entity.hasCompositePrimaryKey() )
#foreach( $field in $entity.attributes )
#if( $field.isFK() )
#set( $check_fk = true )
#set( $foreign_table_cap = $field.referencedEntityName )
#set( $foreign_table = ${fn.toLowerCase($field.referencedEntityName)} )
from services.${foreign_table_cap}_service import ${field.referencedEntityName}Service
${foreign_table}_service = ${field.referencedEntityName}Service()

#set( $list = $list + "list_" + $foreign_table + "=list_" + $foreign_table + ", ")
## #set( $select = $select + "select_" + $foreign_table + "=select_" + $foreign_table + ", ")
#end
#end
#end

#foreach( $field in $entity.nonKeyAttributes )
#if( $field.isFK() )
#set( $check_fk = true )
#set( $cpt = $cpt + 1 )
#set( $foreign_table_cap = $field.referencedEntityName )
#set( $foreign_table = ${fn.toLowerCase($field.referencedEntityName)} )
from services.${foreign_table_cap}_service import ${field.referencedEntityName}Service
${foreign_table}_service =${field.referencedEntityName}Service()

#set( $list = $list + "list_" + $foreign_table + "=list_" + $foreign_table + ", ")
## #set( $select = $select + "select_" + $foreign_table + "=select_" + $foreign_table + ", ")
#end
#end
## #set( $select = $list + $select)

${entity.name.toUpperCase()}_FORM_TPL = "${entity.name}_form.tpl"
${entity.name.toUpperCase()}_LIST_TPL = "${entity.name}_list.tpl"

@route('/${entity.name.toLowerCase()}')
@view("navigation_bar.tpl")
def get_all():
    return print_list()

def print_list(message=""):
    try:
        entities = ${entity.name.toLowerCase()}_service.find_all()
        # return common_controller.get_all(entities, "${entity.name}", "")
        # return build_list_body(entities, "${entity.name}", "")
        entities_as_dict = [entity.to_dict() for entity in entities]
        body = template(${entity.name.toUpperCase()}_LIST_TPL, list=entities_as_dict, message=message)
        return {"body": body}
    
    except Exception as e:
        return error_msg(e)
    
@route('/${entity.name.toLowerCase()}/form')
@view("navigation_bar.tpl")
def form_for_create():
    ${SHARP} referenced entity with nothing selected => None
#if( $entity.hasCompositePrimaryKey() )
#foreach( $attribute in $entity.keyAttributes )
#set( $foreign_key = $fn.toLowerCase($attribute.referencedEntityName) )
    list_${foreign_key} = ${foreign_key}_service.find_all_list_items(None)
#end
#end
#foreach( $attribute in $entity.nonKeyAttributes )
#if( $attribute.isFK() )
#set( $foreign_key = $fn.toLowerCase($attribute.referencedEntityName) )
    list_${foreign_key} = ${foreign_key}_service.find_all_list_items(None)
#end
#end
    ${SHARP} Form without entity
    body = template(${entity.name.toUpperCase()}_FORM_TPL#if($check_fk), $list#else,#end form=FORM_CREATE_MODE, message="")
    return {"body": body}

@route('/${entity.name.toLowerCase()}/form/$entity.keyAttributesNamesAsString('/', '<', '>')')
@view("navigation_bar.tpl")
def form_for_update($entity.keyAttributesNamesAsString(', ')):
    ${SHARP} Load entity from database
    entity = ${entity.name.toLowerCase()}_service.find_by_id($entity.keyAttributesNamesAsString(', '))
    ${SHARP} Print the form 
    return form_with_entity(entity)

def form_with_entity(entity, message=""):
    ${SHARP} referenced entity with current value selected
#if( $entity.hasCompositePrimaryKey() )
#foreach( $attribute in $entity.keyAttributes )
#set( $foreign_key = $fn.toLowerCase($attribute.referencedEntityName) )
    list_${foreign_key} = ${foreign_key}_service.find_all_list_items(entity.$entity.keyAttributesNamesAsString(', '))
#end
#end
#foreach( $attribute in $entity.nonKeyAttributes )
#if( $attribute.isFK() )
#set( $foreign_key = $fn.toLowerCase($attribute.referencedEntityName) )
    list_${foreign_key} = ${foreign_key}_service.find_all_list_items(entity.$entity.keyAttributesNamesAsString(', '))
#end
#end
##    body = template(${entity.name.toUpperCase()}_FORM_TPL#if($check_fk), $select#else, #end entity=entity.to_dict(), form=FORM_UPDATE_MODE, message=message)
    body = template(${entity.name.toUpperCase()}_FORM_TPL#if($check_fk), $list#else, #end entity=entity.to_dict(), form=FORM_UPDATE_MODE, message=message)
    return {"body": body}

@route('/${entity.name.toLowerCase()}/create', method='POST')
@view("navigation_bar.tpl")
def create():
    try:
        entity = ${entity.name}()
#foreach( $field in $entity.attributes )
#if( $field.isTemporalType() )
        date_convert = request.forms.get('${field.name}')
        if date_convert:
            entity.${field.name} = datetime.datetime.strptime(date_convert, "%Y-%m-%d")
        else:
            entity.${field.name} = date_convert
#else
        entity.${field.name} = request.forms.get('${field.name}')
#end
#end
        ${SHARP} Insert in database
        result = ${entity.name.toLowerCase()}_service.insert(entity)
        message = create_msg(result, ${entity.name})
    except Exception as e:
        message = error_msg(e)
    return form_with_entity(entity, message)

@route('/${entity.name.toLowerCase()}/update', method='POST')
@view('navigation_bar.tpl')
def update():
    try:
        entity = ${entity.name}()
#foreach( $field in $entity.attributes )
#if( $field.isTemporalType() )
        date_convert = request.forms.get('${field.name}')
        if date_convert:
            entity.${field.name} = datetime.datetime.strptime(date_convert, "%Y-%m-%d")
        else:
            entity.${field.name} = date_convert
#else
        entity.${field.name} = request.forms.get('${field.name}')
#end
#end
        ${SHARP} Update in database
        result = ${entity.name.toLowerCase()}_service.update(entity)
        message = update_msg(result)
    except Exception as e:
        message = error_msg(e)
    return form_with_entity(entity, message)

@route('/${entity.name.toLowerCase()}/delete/$entity.keyAttributesNamesAsString('/', '<', '>')')
@view('navigation_bar.tpl')
def delete($entity.keyAttributesNamesAsString(', ')):
    try:
        ${SHARP} Delete in database
        result = ${entity.name.toLowerCase()}_service.delete_by_id($entity.keyAttributesNamesAsString(', '))
        message = delete_msg(result)
    except Exception as e:
        message = error_msg(e)
    return print_list(message)
